name: Validate Tools

on:
  push:
    paths:
      - '.toolkit/**'
      - '.canon/**'
      - '.github/workflows/**'
  pull_request:
    paths:
      - '.toolkit/**'
      - '.canon/**'

jobs:
  validate-tool-contracts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml pytest

      - name: Run unit tests
        run: |
          set -e
          pytest -q .toolkit/tests

      - name: Validate tool contracts
        run: |
          set -e
          # Validate tools under .toolkit/tools and .toolkit/custom-tools
          for d in .toolkit/tools/* .toolkit/custom-tools/*; do
            if [ -d "$d" ]; then
              echo "Validating $d"
              python3 .toolkit/validate/validate_tool_contracts.py "$d"
            fi
          done

      - name: Validate NDJSON changelogs
        run: |
          set -e
          python3 .toolkit/validate/validate_logs.py

      - name: Validate engine activation
        run: |
          set -e
          python3 .toolkit/validate/validate_engine_activation.py

      - name: Validate ingestion logs
        run: |
          set -e
          python3 .toolkit/validate/validate_ingestion.py

